<!DOCTYPE html>
<html><head>
<meta charset="utf-8"/>

<!-- CSS.Canvasloth -->
<link type="text/css" rel="stylesheet" href="../../Canvasloth.css"/>
<!-- CSS.main -->
<style type="text/css">	
	.canvasloth { width:1024px; height:720px; background:#aaf; }
	.canvasloth-mouse { background:red; }
</style>

<!-- JS.JsExt -->
<script type="text/javascript" src="../../../JsExt/ClassName.js"></script>
<script type="text/javascript" src="../../../JsExt/CSS.js"></script>
<script type="text/javascript" src="../../../JsExt/CSSAnim.js"></script>
<script type="text/javascript" src="../../../JsExt/DOMNavigate.js"></script>
<script type="text/javascript" src="../../../JsExt/DOMSelector.js"></script>
<script type="text/javascript" src="../../../JsExt/EventsManager.js"></script>
<script type="text/javascript" src="../../../JsExt/MathInterp.js"></script>
<script type="text/javascript" src="../../../JsExt/OffsetPosition.js"></script>
<!-- JS.Canvasloth -->
<script type="text/javascript" src="../../Canvasloth.js"></script>
<script type="text/javascript" src="../../Canvas/Canvas.js"></script>
<script type="text/javascript" src="../../Events/Events.js"></script>
<script type="text/javascript" src="../../Hud/Pages.js"></script>
<script type="text/javascript" src="../../Hud/DomIntIncrease.js"></script>
<script type="text/javascript" src="../../Assets/Assets.js"></script>
<script type="text/javascript" src="../../Assets/Images.js"></script>
<script type="text/javascript" src="../../Assets/Sprites.js"></script>
<script type="text/javascript" src="../../Assets/Anims.js"></script>
<script type="text/javascript" src="../../Time/Time.js"></script>
<script type="text/javascript" src="../../Math/Math.js"></script>
<script type="text/javascript" src="../../Math/Matrix.js"></script>
<script type="text/javascript" src="../../Math/Vector.js"></script>
<script type="text/javascript" src="../../Ctx3D/Ctx3D.js"></script>
<script type="text/javascript" src="../../Ctx3D/WebGLRenderingContext_Matrix.js"></script>
<script type="text/javascript" src="../../Ctx3D/WebGLRenderingContext_Camera.js"></script>
<script type="text/javascript" src="../../Ctx3D/CameraMatrixFunctions.js"></script>
<script type="text/javascript" src="../../Ctx3D/Shaders.js"></script>
<script type="text/javascript" src="../../Math/gl-matrix.js"></script> <!-- tmp -->

<script>
function lg(s) { console.log(s); }

window.onload = function() {

var WebGL_Editor = {
	ready: function(canvasloth) {
		this.canvasloth = canvasloth;
		var vertices, normals, texCoords, indices, colors;
		var gl = canvasloth.getCtx();
		this.program = gl._shaders.getProgram();
		
		vertices = [
			 0.5, 0.5, 0.5,  -0.5, 0.5, 0.5,  -0.5,-0.5, 0.5,   0.5,-0.5, 0.5, // v0-v1-v2-v3 front
			 0.5, 0.5, 0.5,   0.5,-0.5, 0.5,   0.5,-0.5,-0.5,   0.5, 0.5,-0.5, // v0-v3-v4-v5 right
			 0.5, 0.5, 0.5,   0.5, 0.5,-0.5,  -0.5, 0.5,-0.5,  -0.5, 0.5, 0.5, // v0-v5-v6-v1 top
			-0.5, 0.5, 0.5,  -0.5, 0.5,-0.5,  -0.5,-0.5,-0.5,  -0.5,-0.5, 0.5, // v1-v6-v7-v2 left
			-0.5,-0.5,-0.5,   0.5,-0.5,-0.5,   0.5,-0.5, 0.5,  -0.5,-0.5, 0.5, // v7-v4-v3-v2 bottom
			 0.5,-0.5,-0.5,  -0.5,-0.5,-0.5,  -0.5, 0.5,-0.5,   0.5, 0.5,-0.5  // v4-v7-v6-v5 back
		];

		// normal array
		normals = [
			 0, 0, 1,   0, 0, 1,   0, 0, 1,   0, 0, 1, // v0-v1-v2-v3 front
			 1, 0, 0,   1, 0, 0,   1, 0, 0,   1, 0, 0, // v0-v3-v4-v5 right
			 0, 1, 0,   0, 1, 0,   0, 1, 0,   0, 1, 0, // v0-v5-v6-v1 top
			-1, 0, 0,  -1, 0, 0,  -1, 0, 0,  -1, 0, 0, // v1-v6-v7-v2 left
			 0,-1, 0,   0,-1, 0,   0,-1, 0,   0,-1, 0, // v7-v4-v3-v2 bottom
			 0, 0,-1,   0, 0,-1,   0, 0,-1,   0, 0,-1  // v4-v7-v6-v5 back
			 ];

		// texCoord array
		texCoords = [
			1, 1,   0, 1,   0, 0,   1, 0, // v0-v1-v2-v3 front
			0, 1,   0, 0,   1, 0,   1, 1, // v0-v3-v4-v5 right
			1, 0,   1, 1,   0, 1,   0, 0, // v0-v5-v6-v1 top
			1, 1,   0, 1,   0, 0,   1, 0, // v1-v6-v7-v2 left
			0, 0,   1, 0,   1, 1,   0, 1, // v7-v4-v3-v2 bottom
			0, 0,   1, 0,   1, 1,   0, 1  // v4-v7-v6-v5 back
		];

		// index array
		indices = [
			 0,  1,  2,     0,  2,  3, // front
			 4,  5,  6,     4,  6,  7, // right
			 8,  9, 10,     8, 10, 11, // top
			12, 13, 14,    12, 14, 15, // left
			16, 17, 18,    16, 18, 19, // bottom
			20, 21, 22,    20, 22, 23  // back
		];

		// Set up the array of colors for the cube's faces
		colors = [
			0, 0, 255, 255,     0, 0, 255, 255,     0, 0, 255, 255,       0, 0, 255, 255, // v0-v1-v2-v3 front  BLEU
			255, 0, 0, 255,     255, 0, 0, 255,     255, 0, 0, 255,       255, 0, 0, 255, // v0-v3-v4-v5 right  ROUGE
			0, 255, 0, 255,     0, 255, 0, 255,     0, 255, 0, 255,       0, 255, 0, 255, // v0-v5-v6-v1 top    VERT
			0, 255, 255, 255,   0, 255, 255, 255,   0, 255, 255, 255,     0, 255, 255, 255, // v1-v6-v7-v2 left   TURQUOISE
			255, 0, 255, 255,   255, 0, 255, 255,   255, 0, 255, 255,     255, 0, 255, 255, // v7-v4-v3-v2 bottom ROSE
			255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255,   255, 255, 255, 255  // v4-v7-v6-v5 back   BLANC
		];

		this.cube1 = gl.createObject('cube', vertices, normals, texCoords, indices, colors);

		vertices = [
			 1, 1, 1,  -1, 1, 1,  -1,-1, 1,   1,-1, 1, // v0-v2-v2-v3 front
			 1, 1, 1,   1,-1, 1,   1,-1,-1,   1, 1,-1, // v0-v3-v4-v5 right
			 1, 1, 1,   1, 1,-1,  -1, 1,-1,  -1, 1, 1, // v0-v5-v6-v2 top
			-1, 1, 1,  -1, 1,-1,  -1,-1,-1,  -1,-1, 1, // v2-v6-v7-v2 left
			-1,-1,-1,   1,-1,-1,   1,-1, 1,  -1,-1, 1, // v7-v4-v3-v2 bottom
			 1,-1,-1,  -1,-1,-1,  -1, 1,-1,   1, 1,-1  // v4-v7-v6-v5 back
		];

		colors = [
			58, 103, 255, 255,   58, 103, 255, 255,   58, 103, 255, 255,   58, 103, 255, 255,
			56, 124, 255, 255,   56, 124, 255, 255,   56, 124, 255, 255,   56, 124, 255, 255,
			56, 156, 232, 255,   56, 156, 232, 255,   56, 156, 232, 255,   56, 156, 232, 255,
			74, 218, 255, 255,   74, 218, 255, 255,   74, 218, 255, 255,   74, 218, 255, 255,
			56, 232, 228, 255,   56, 232, 228, 255,   56, 232, 228, 255,   56, 232, 228, 255,
			62, 255, 204, 255,   62, 255, 204, 255,   62, 255, 204, 255,   62, 255, 204, 255  
		];

		this.cube2 = gl.createObject('cube', vertices, normals, texCoords, indices, colors);


		//Sphere
		colors.length = vertices.length = normals.length = texCoords.length = indices.length = 0;
		
		var latitude  = 128;
		var longitude = 128;
		var radius    = 2;
		var sphereColor = [255, 255, 255, 255];

		for (var currentLat = 0; currentLat <= latitude; currentLat++) {
			var theta = currentLat * Math.PI / latitude;
			var sinTheta = Math.sin(theta);
			var cosTheta = Math.cos(theta);

			for (var currentLong = 0; currentLong <= longitude; currentLong++) {
				var phi = currentLong * 2 * Math.PI / longitude;
				var sinPhi = Math.sin(phi);
				var cosPhi = Math.cos(phi);

				var x = cosPhi * sinTheta;
				var y = cosTheta;
				var z = sinPhi * sinTheta;
				var u = 1 - (currentLong / longitude);
				var v = 1 - (currentLat / latitude);

				normals.push(x);
				normals.push(y);
				normals.push(z);
				colors.push(sphereColor[0]);
				colors.push(sphereColor[1]);
				colors.push(sphereColor[2]);
				colors.push(sphereColor[3]);
				vertices.push(radius * x);
				vertices.push(radius * y);
				vertices.push(radius * z);
			}
		}

		for (var currentLat = 0; currentLat < latitude; currentLat++) {
			for (var currentLong = 0; currentLong < longitude; currentLong++) {
				var first = (currentLat * (longitude + 1)) + currentLong;
				var second = first + longitude + 1;
				indices.push(first);
				indices.push(second);
				indices.push(first + 1);

				indices.push(second);
				indices.push(second + 1);
				indices.push(first + 1);
			}
		}
		lg(indices);

		this.sphere = gl.createObject('sphere', vertices, normals, texCoords, indices, colors);
		lg("on est sorti de create obj");
		gl.ambientLightAttrib();
		gl.ambientLight(0.2, 0.2, 0.2);
		gl.enableAmbLight(true);

		gl.dirLightAttrib();
		gl.dirLight(0.2, 0.7, -0.5, 0.5, 0.2, 0.8);
		gl.enableDirLight(true);
		
		gl.enableVertexAttribArray(0);
		gl.enableVertexAttribArray(1);
		gl.enableVertexAttribArray(2);
		gl.camera.spherique(true);
		gl.camera.auto();
	},
	update: function(time) {
	},
	render: function(gl) {
		gl.matrix.translate(0, 3, 0);
		gl.bindObject(this.cube1);
		gl.drawObject(gl.TRIANGLES, this.cube1.faces.itemNumber, gl.UNSIGNED_SHORT, 0);

		gl.matrix.translate(0, -5, 0);
		gl.bindObject(this.cube2);
		gl.drawObject(gl.TRIANGLES, this.cube2.faces.itemNumber, gl.UNSIGNED_SHORT, 0);

		gl.matrix.translate(-5, 2, 0);
		gl.bindObject(this.sphere);
		lg(this.sphere.faces.itemNumber);
		gl.drawObject(gl.TRIANGLES, this.sphere.faces.itemNumber, gl.UNSIGNED_SHORT, 0);
	}
};

var canvasloth = new Canvasloth({
	type : '3d',
	node : document._domSelector('.canvasloth')[0],
	app  : WebGL_Editor,
	fn   : {
		'ready'  : WebGL_Editor.ready,
		'update' : WebGL_Editor.update,
		'render' : WebGL_Editor.render
	}
});

};
</script>
</head>

<body>

	<div class="canvasloth canvasloth-dark">
		<script type="x-shader/x-vertex">
			attribute vec3 aVertexNormal;
			attribute vec4 aVertexColor;
			attribute vec4 aVertexPosition;
			
			uniform mat4 uNMatrix;
			uniform mat4 uMVMatrix;
			uniform mat4 uPMatrix;
			
			varying vec4 vColor;
			varying vec4 vFinalLight;

			uniform vec3 uAmbientColor;
			uniform vec3 uLightingDirection;
			uniform vec3 uDirectionalColor;
			uniform bool uUseAmbLighting;
			uniform bool uUseDirLighting;
			varying vec3 vLightWeighting;

			void main(void) {
				if (!uUseAmbLighting) {
					vFinalLight = vec4(1.0, 1.0, 1.0, 1.0);
				} else if (uUseAmbLighting && !uUseDirLighting){	
					vFinalLight = vec4(uAmbientColor, 1.0) ;
				} else {
					vec3 N = normalize(vec3(uNMatrix * vec4(aVertexNormal, 1.0)));
					vec3 L = normalize(uLightingDirection);
					float lambertCoef = max(dot(N, -L), 0.0);
					vFinalLight.xyz = uAmbientColor + uDirectionalColor * lambertCoef;
					vFinalLight.a = 1.0;
				}
				vColor = aVertexColor;
				gl_Position = uPMatrix * uMVMatrix * aVertexPosition;
			}
		</script>
		<script type="x-shader/x-fragment">
			precision mediump float;
			varying vec4 vColor;
			varying vec4 vFinalLight;
			varying vec3 vLightWeighting;

			void main(void) {
				gl_FragColor = vColor * vFinalLight;
			}
		</script>
		<div class="canvasloth-hud-passive">
		</div>
	</div>
	Mouvement circulaire de la camera :  clique gauche enfonce + mouvement de la souris<br>
	Avancer ou reculer la camera : roulette de la souris vers le haut ou vers le bas
</body>
</html>
