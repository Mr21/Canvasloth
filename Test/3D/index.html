<!DOCTYPE html>
<html><head>
<meta charset="utf-8"/>

<!-- CSS.Canvasloth -->
<link type="text/css" rel="stylesheet" href="../../Canvasloth.css"/>
<!-- CSS.main -->
<style type="text/css">	
	.canvasloth { width:640px; height:480px; background:#aaf; }
	.canvasloth-mouse { background:red; }
</style>

<!-- JS.JsExt -->
<script type="text/javascript" src="../../../JsExt/ClassName.js"></script>
<script type="text/javascript" src="../../../JsExt/CSS.js"></script>
<script type="text/javascript" src="../../../JsExt/CSSAnim.js"></script>
<script type="text/javascript" src="../../../JsExt/DOMNavigate.js"></script>
<script type="text/javascript" src="../../../JsExt/DOMSelector.js"></script>
<script type="text/javascript" src="../../../JsExt/EventsManager.js"></script>
<script type="text/javascript" src="../../../JsExt/MathInterp.js"></script>
<script type="text/javascript" src="../../../JsExt/OffsetPosition.js"></script>
<!-- JS.Canvasloth -->
<script type="text/javascript" src="../../Canvasloth.js"></script>
<script type="text/javascript" src="../../Canvas/Canvas.js"></script>
<script type="text/javascript" src="../../Hud/Pages.js"></script>
<script type="text/javascript" src="../../Hud/DomIntIncrease.js"></script>
<script type="text/javascript" src="../../Assets/Assets.js"></script>
<script type="text/javascript" src="../../Assets/Images.js"></script>
<script type="text/javascript" src="../../Assets/Sprites.js"></script>
<script type="text/javascript" src="../../Assets/Anims.js"></script>
<script type="text/javascript" src="../../Time/Time.js"></script>
<script type="text/javascript" src="../../Math/Math.js"></script>
<script type="text/javascript" src="../../Math/Matrix.js"></script>
<script type="text/javascript" src="../../Math/Vector.js"></script>
<script type="text/javascript" src="../../Math/J3DIMath.js"></script>
<script type="text/javascript" src="../../Ctx3D/Ctx3D.js"></script>
<script type="text/javascript" src="../../Ctx3D/CameraMatrixFunctions.js"></script>
<script type="text/javascript" src="../../Ctx3D/Shaders.js"></script>
<!-- Demo -->
<script type="text/javascript" src="J3DI.js"></script>

<script>
function lg(s) { console.log(s); }

window.onload = function() {

var WebGL_Editor = {
	ready: function(canvasloth) {
		this.canvasloth = canvasloth;

		canvasloth.addEvent('update', this.update);
		canvasloth.addEvent('render', this.render);

		var gl = canvasloth.getCtx();
		this.program = gl._shaders.getProgram();
		
		// Create a box. On return 'gl' contains a 'box' property with
		// the BufferObjects containing the arrays for vertices, normals, texture coords, and indices.
		this.box = makeBox(gl);

		// Set up the array of colors for the cube's faces
		var colors = new Uint8Array([
			0, 0, 1, 1,   0, 0, 1, 1,   0, 0, 1, 1,   0, 0, 1, 1,  // v0-v1-v2-v3 front  BLEU
			1, 0, 0, 1,   1, 0, 0, 1,   1, 0, 0, 1,   1, 0, 0, 1,  // v0-v3-v4-v5 right  ROUGE
			0, 1, 0, 1,   0, 1, 0, 1,   0, 1, 0, 1,   0, 1, 0, 1,  // v0-v5-v6-v1 top    VERT
			1, 1, 1, 1,   1, 1, 1, 1,   1, 1, 1, 1,   1, 1, 1, 1,  // v1-v6-v7-v2 left   BLANC
			1, 0, 1, 1,   1, 0, 1, 1,   1, 0, 1, 1,   1, 0, 1, 1,  // v7-v4-v3-v2 bottom 
			0, 1, 1, 1,   0, 1, 1, 1,   0, 1, 1, 1,   0, 1, 1, 1   // v4-v7-v6-v5 back   
		]);

		// Set up the vertex buffer for the colors
		this.box.colorObject = gl.createBuffer();
		gl.bindBuffer(gl.ARRAY_BUFFER, this.box.colorObject);
		gl.bufferData(gl.ARRAY_BUFFER, colors, gl.STATIC_DRAW);

		// Enable all of the vertex attribute arrays.
		gl.enableVertexAttribArray(0);
		gl.enableVertexAttribArray(1);
		gl.enableVertexAttribArray(2);

		// Set up all the vertex attributes for vertices, normals and colors
		gl.bindBuffer(gl.ARRAY_BUFFER, this.box.vertexObject); gl.vertexAttribPointer(2, 3, gl.FLOAT,         false, 0, 0);
		gl.bindBuffer(gl.ARRAY_BUFFER, this.box.normalObject); gl.vertexAttribPointer(0, 3, gl.FLOAT,         false, 0, 0);
		gl.bindBuffer(gl.ARRAY_BUFFER, this.box.colorObject);  gl.vertexAttribPointer(1, 4, gl.UNSIGNED_BYTE, false, 0, 0);

		gl._camera_spherique(true);
		gl._camera_auto();
	},
	update: function(time) {
	},
	render: function(gl) {
		/*gl._lookAt(
			-3, 2, 5, // eye
			0, 0, 0, // center
			0, 0, 1  // up
		);*/

		//gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this.cubeVerticesIndexBuffer);
		//gl._drawElements(gl.TRIANGLES, 36, gl.UNSIGNED_SHORT, 0);

		gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, this.box.indexObject);

		var n = 1;
		for (var x = -n; x <= n; ++x) {
			for (var y = -n; y <= n; ++y) {
				gl._pushMatrix();
					gl._translate(x * 5, y * 5, 0);
						gl._drawElements(gl.TRIANGLES, this.box.numIndices, gl.UNSIGNED_BYTE, 0);
				gl._popMatrix();
			}
		}
	}
};

var canvasloth = new Canvasloth({
	type : '3d',
	node : document._domSelector('.canvasloth')[0],
	app  : WebGL_Editor
});

};
</script>
</head>

<body>

	<div class="canvasloth canvasloth-dark">
		<script id="vshader" type="x-shader/x-vertex">
			uniform mat4 u_modelViewProjMatrix;
			uniform mat4 u_normalMatrix;
			uniform vec3 lightDir;
			attribute vec3 vNormal;
			attribute vec4 vColor;
			attribute vec4 vPosition;
			varying float v_Dot;
			varying vec4 v_Color;
			void main(void) {
				gl_Position = u_modelViewProjMatrix * vPosition;
				v_Color = vColor;
				vec4 transNormal = u_normalMatrix * vec4(vNormal, 1);
				v_Dot = max(dot(transNormal.xyz, lightDir), 0.0);
			}
		</script>
		<script id="fshader" type="x-shader/x-fragment">
			precision mediump float;
			varying float v_Dot;
			varying vec4 v_Color;
			void main(void) {
				gl_FragColor = vec4(v_Color.xyz * v_Dot, v_Color.a);
			}
		</script>
		<div class="canvasloth-hud-passive">
		</div>
	</div>

</body>
</html>
